# JM漫画下载邮件通知功能

## 功能简介

新增的邮件通知功能可以在JM漫画下载完成后，自动将压缩文件作为邮件附件发送到您的邮箱。无需手动下载GitHub Artifacts，直接在邮箱中获取下载的漫画文件。

## 主要优势

- 🚀 **自动发送**：下载完成后自动发送，无需人工干预
- 📎 **支持大附件**：自动分割超过20MB的文件，支持任意大小的漫画包
- 📧 **多种邮箱**：支持Gmail、QQ邮箱、163邮箱、Outlook等主流邮箱
- 🔄 **智能重试**：网络异常时自动重试，确保发送成功
- 🗂️ **多种格式**：同时发送图片压缩包(tar.gz)和PDF文件(zip)

## 使用步骤

### 第一步：配置邮箱

#### Gmail邮箱配置
1. 开启两步验证：访问 https://myaccount.google.com/security
2. 生成应用专用密码：在两步验证页面找到「应用专用密码」
3. 选择「邮件」和「其他设备」，生成16位密码

#### QQ邮箱配置
1. 登录QQ邮箱网页版
2. 设置 → 账户 → 开启「SMTP服务」
3. 发送短信获取16位授权码

#### 163邮箱配置
1. 登录163邮箱网页版
2. 设置 → POP3/SMTP/IMAP → 开启「SMTP服务」
3. 设置客户端授权密码

### 第二步：配置GitHub Secrets

在GitHub仓库页面，进入 Settings → Secrets and variables → Actions，添加以下配置：

```
# JM登录信息
JM_USERNAME=你的JM用户名
JM_PASSWORD=你的JM密码

# 邮箱配置
SMTP_SERVER=smtp.gmail.com          # 邮箱服务器地址
SMTP_SSL=true                       # 是否使用SSL
SMTP_EMAIL=your_email@gmail.com     # 你的邮箱地址
SMTP_PASSWORD=your_app_password     # 应用专用密码或授权码
SMTP_NAME=JM漫画下载服务            # 发件人名称
```

### 第三步：运行工作流

1. 进入GitHub仓库的Actions页面
2. 选择「下载JM本子并发送邮件 (dispatch)」工作流
3. 点击「Run workflow」按钮
4. 填写参数：
   - **JM_ALBUM_IDS**：本子ID（必填，如：422866）
   - **EMAIL_TITLE**：邮件标题（可选）
   - **EMAIL_CONTENT**：邮件内容（可选）
   - 其他参数与原工作流相同
5. 点击「Run workflow」开始执行

### 第四步：查收邮件

- 工作流运行完成后，检查您的邮箱
- 如果文件较大，可能会收到多封邮件（自动分批发送）
- 下载邮件附件即可获得漫画文件

## 常用邮箱配置参考

| 邮箱服务 | SMTP_SERVER | SMTP_SSL | 备注 |
|---------|-------------|----------|------|
| Gmail | smtp.gmail.com | true | 需要应用专用密码 |
| QQ邮箱 | smtp.qq.com | true | 需要授权码 |
| 163邮箱 | smtp.163.com | true | 需要授权码 |
| Outlook | smtp-mail.outlook.com | true | 使用账户密码 |
| 126邮箱 | smtp.126.com | true | 需要授权码 |

## 本地测试

在配置完成后，可以先在本地测试邮件功能：

```bash
# 设置环境变量（Windows）
set SMTP_SERVER=smtp.gmail.com
set SMTP_EMAIL=your_email@gmail.com
set SMTP_PASSWORD=your_password
set SMTP_SSL=true

# 设置环境变量（Linux/Mac）
export SMTP_SERVER=smtp.gmail.com
export SMTP_EMAIL=your_email@gmail.com
export SMTP_PASSWORD=your_password
export SMTP_SSL=true

# 运行测试脚本
python test_email_notification.py
```

## 故障排除

### 邮件发送失败
- 检查SMTP服务器地址是否正确
- 确认邮箱用户名和密码是否正确
- 验证是否开启了SMTP服务
- 检查是否使用了应用专用密码（而非登录密码）

### 收不到邮件
- 检查垃圾邮件文件夹
- 确认邮箱地址是否正确
- 查看GitHub Actions运行日志

### 附件过大
- 系统会自动分割大文件
- 如果仍然失败，可能是邮箱服务商限制
- 建议使用Gmail等支持大附件的邮箱

## 高级功能

### 自定义邮件内容

可以在运行工作流时自定义邮件标题和内容：

```
EMAIL_TITLE: 🎉 您的JM漫画下载完成啦！
EMAIL_CONTENT: |
  亲爱的用户，
  
  您请求的JM漫画已经下载完成，请查看邮件附件。
  
  下载信息：
  - 下载时间：2025年1月11日
  - 文件格式：tar.gz 和 PDF
  
  感谢使用我们的服务！
```

### 通过notification-service发送

如果您有独立的notification-service仓库，可以使用更强大的发送功能：

```
# 额外配置
GITHUB_TOKEN=your_github_token
NOTIFICATION_REPO=your_username/notification-service
```

这种方式支持更多功能，如重试机制、多种通知方式等。

## 安全提醒

1. **保护敏感信息**：不要在代码中硬编码密码，始终使用GitHub Secrets
2. **使用专用密码**：建议使用应用专用密码而非主密码
3. **定期更换**：定期更换密码和Token
4. **权限控制**：GitHub Token使用最小权限原则

## 技术支持

如遇问题，请：
1. 查看GitHub Actions运行日志
2. 运行本地测试脚本
3. 检查邮箱配置是否正确
4. 在Issues中提交问题报告

---

**享受便捷的JM漫画下载体验！** 📚✨