name: ä¸‹è½½JMæœ¬å­å¹¶å‘é€é€šçŸ¥

on:
  workflow_dispatch:
    inputs:
      JM_ALBUM_IDS:
        type: string
        description: æœ¬å­idï¼ˆå¤šä¸ªidç”¨-éš”å¼€ï¼Œå¦‚ '123-456-789'ï¼‰
        required: false

      JM_PHOTO_IDS:
        type: string
        description: ç« èŠ‚idï¼ˆå•ç‹¬ä¸‹è½½ç« èŠ‚ï¼Œå¤šä¸ªidåŒä¸Šï¼‰
        required: false

      CLIENT_IMPL:
        type: string
        description: å®¢æˆ·ç«¯ç±»å‹ï¼ˆclient.implï¼‰ï¼Œä¸‹è½½å¤±è´¥æ—¶ï¼Œä½ å¯ä»¥å°è¯•å¡«å…¥æ­¤é¡¹é‡è¯•ã€‚'api' è¡¨ç¤ºç§»åŠ¨ç«¯ï¼Œ'html' è¡¨ç¤ºç½‘é¡µç«¯ã€‚
        default: ''
        required: false

      IMAGE_SUFFIX:
        type: string
        description: å›¾ç‰‡åç¼€ï¼ˆdownload.cache.suffixï¼‰ï¼Œé»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºä¸åšå›¾ç‰‡æ ¼å¼è½¬æ¢ã€‚å¯å¡«å…¥ä¾‹å¦‚ 'png' 'jpg'
        default: ''
        required: false

      DIR_RULE:
        type: string
        description: ä¸‹è½½æ–‡ä»¶å¤¹è§„åˆ™ï¼ˆdir_rule.ruleï¼‰ã€‚é»˜è®¤ä½¿ç”¨é…ç½®æ–‡ä»¶çš„ 'Bd_Aauthor_Atitle_Pindex'ã€‚
        default: ''
        required: false

      ZIP_NAME:
        type: string
        default: æœ¬å­.tar.gz
        description: å‹ç¼©æ–‡ä»¶åç§°
        required: false

      UPLOAD_NAME:
        type: string
        default: Click me to download
        description: ä¸Šä¼ æ–‡ä»¶åç§°
        required: false

      ENABLE_PDF:
        type: boolean
        default: true
        description: æ˜¯å¦ç”ŸæˆPDFæ–‡ä»¶
        required: false

      PDF_ZIP_NAME:
        type: string
        default: æœ¬å­PDF.zip
        description: PDFå‹ç¼©æ–‡ä»¶åç§°
        required: false

      PDF_UPLOAD_NAME:
        type: string
        default: Click me to download PDF
        description: PDFä¸Šä¼ æ–‡ä»¶åç§°
        required: false

jobs:
  crawler:
    runs-on: ubuntu-latest
    env:
      # å·¥ä½œæµè¾“å…¥
      JM_ALBUM_IDS: ${{ github.event.inputs.JM_ALBUM_IDS }}
      JM_PHOTO_IDS: ${{ github.event.inputs.JM_PHOTO_IDS }}
      DIR_RULE: ${{ github.event.inputs.DIR_RULE }}
      CLIENT_IMPL: ${{ github.event.inputs.CLIENT_IMPL }}
      ZIP_NAME: ${{ github.event.inputs.ZIP_NAME }}
      UPLOAD_NAME: ${{ github.event.inputs.UPLOAD_NAME }}
      IMAGE_SUFFIX: ${{ github.event.inputs.IMAGE_SUFFIX }}
      ENABLE_PDF: ${{ github.event.inputs.ENABLE_PDF }}
      PDF_ZIP_NAME: ${{ github.event.inputs.PDF_ZIP_NAME }}
      PDF_UPLOAD_NAME: ${{ github.event.inputs.PDF_UPLOAD_NAME }}

      # é€šçŸ¥ç›¸å…³å¸¸é‡ï¼ˆåœ¨è¿™é‡Œä¿®æ”¹é…ç½®ï¼‰
      NOTIFICATION_REPO:  ${{ secrets.NOTIFICATION_REPO }} # 'your-username/notification-service'  # ä¿®æ”¹ä¸ºä½ çš„é€šçŸ¥æœåŠ¡ä»“åº“
      ENABLE_NOTIFICATION: true
      NOTIFICATION_TITLE: 'JMæ¼«ç”»ä¸‹è½½å®Œæˆ'

      # ç™»å½•ç›¸å…³secrets
      JM_USERNAME: ${{ secrets.JM_USERNAME }}
      JM_PASSWORD: ${{ secrets.JM_PASSWORD }}

      # é‚®ä»¶ç›¸å…³secrets
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      EMAIL_TITLE: ${{ secrets.EMAIL_TITLE }}
      EMAIL_CONTENT: ${{ secrets.EMAIL_CONTENT }}

      # å›ºå®šå€¼
      JM_DOWNLOAD_DIR: /home/runner/work/jmcomic/download/
      JM_PDF_DIR: /home/runner/work/jmcomic/pdf/

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependency
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install img2pdf

      - name: å®‰è£…jmcomicï¼ˆpipï¼‰
        if: ${{ github.ref != 'refs/heads/dev' }}
        run: |
          pip install jmcomic -i https://pypi.org/project --upgrade

      - name: å®‰è£…jmcomicï¼ˆlocalï¼‰
        if: ${{ github.ref == 'refs/heads/dev' }}
        run: |
          pip install -e ./

      - name: è¿è¡Œä¸‹è½½è„šæœ¬
        run: |
          cd ./usage/
          python workflow_download.py

      - name: å‹ç¼©å›¾ç‰‡æ–‡ä»¶
        run: |
          cd $JM_DOWNLOAD_DIR
          tar -zcvf "../$ZIP_NAME" ./
          mv "../$ZIP_NAME" .

      - name: å‹ç¼©PDFæ–‡ä»¶
        if: ${{ env.ENABLE_PDF == 'true' }}
        run: |
          if [ -d "$JM_PDF_DIR" ] && [ "$(ls -A $JM_PDF_DIR)" ]; then
            cd $JM_PDF_DIR
            zip -r "../$PDF_ZIP_NAME" ./
            mv "../$PDF_ZIP_NAME" .
          else
            echo "PDFç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œè·³è¿‡PDFå‹ç¼©"
          fi

      - name: ä¸Šä¼ å›¾ç‰‡ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.UPLOAD_NAME }}
          path: ${{ env.JM_DOWNLOAD_DIR }}/${{ env.ZIP_NAME }}
          if-no-files-found: error
          retention-days: 90

      - name: ä¸Šä¼ PDFç»“æœ
        if: ${{ env.ENABLE_PDF == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PDF_UPLOAD_NAME }}
          path: ${{ env.JM_PDF_DIR }}/${{ env.PDF_ZIP_NAME }}
          if-no-files-found: ignore
          retention-days: 90

      # å‡†å¤‡é€šçŸ¥é™„ä»¶
      - name: å‡†å¤‡é€šçŸ¥é™„ä»¶
        if: ${{ env.ENABLE_NOTIFICATION == 'true' }}
        id: prepare_attachments
        run: |
          echo "å‡†å¤‡é€šçŸ¥é™„ä»¶..."
          
          # åˆ›å»ºé™„ä»¶ä¿¡æ¯
          attachments='[]'
          
          # å¤„ç†å›¾ç‰‡å‹ç¼©åŒ…
          if [ -f "$JM_DOWNLOAD_DIR/$ZIP_NAME" ]; then
            echo "å‘ç°å›¾ç‰‡å‹ç¼©åŒ…: $ZIP_NAME"
            # å°†æ–‡ä»¶è½¬æ¢ä¸ºbase64
            image_content=$(base64 -w 0 "$JM_DOWNLOAD_DIR/$ZIP_NAME")
            image_size=$(stat -c%s "$JM_DOWNLOAD_DIR/$ZIP_NAME")
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆGitHub APIé™åˆ¶çº¦ä¸º1MBï¼‰
            if [ $image_size -lt 1048576 ]; then
              attachments=$(echo "$attachments" | jq --arg filename "$ZIP_NAME" --arg content "$image_content" --arg type "application/gzip" '. += [{"filename": $filename, "content": $content, "encoding": "base64", "content_type": $type}]')
              echo "å›¾ç‰‡å‹ç¼©åŒ…å·²æ·»åŠ åˆ°é™„ä»¶åˆ—è¡¨"
            else
              echo "å›¾ç‰‡å‹ç¼©åŒ…è¿‡å¤§ï¼Œè·³è¿‡é™„ä»¶ä¼ è¾“"
            fi
          fi
          
          # å¤„ç†PDFå‹ç¼©åŒ…
          if [ "$ENABLE_PDF" == "true" ] && [ -f "$JM_PDF_DIR/$PDF_ZIP_NAME" ]; then
            echo "å‘ç°PDFå‹ç¼©åŒ…: $PDF_ZIP_NAME"
            pdf_content=$(base64 -w 0 "$JM_PDF_DIR/$PDF_ZIP_NAME")
            pdf_size=$(stat -c%s "$JM_PDF_DIR/$PDF_ZIP_NAME")
            
            if [ $pdf_size -lt 1048576 ]; then
              attachments=$(echo "$attachments" | jq --arg filename "$PDF_ZIP_NAME" --arg content "$pdf_content" --arg type "application/zip" '. += [{"filename": $filename, "content": $content, "encoding": "base64", "content_type": $type}]')
              echo "PDFå‹ç¼©åŒ…å·²æ·»åŠ åˆ°é™„ä»¶åˆ—è¡¨"
            else
              echo "PDFå‹ç¼©åŒ…è¿‡å¤§ï¼Œè·³è¿‡é™„ä»¶ä¼ è¾“"
            fi
          fi
          
          # è¾“å‡ºé™„ä»¶ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "attachments<<EOF" >> $GITHUB_OUTPUT
          echo "$attachments" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "é™„ä»¶å‡†å¤‡å®Œæˆï¼Œå…± $(echo "$attachments" | jq length) ä¸ªæ–‡ä»¶"

      # å‘é€é€šçŸ¥
      - name: å‘é€ä¸‹è½½å®Œæˆé€šçŸ¥
        if: ${{ env.ENABLE_NOTIFICATION == 'true' }}
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.NOTIFICATION_TOKEN }}
          repository: ${{ secrets.NOTIFICATION_REPO }}
          event-type: send-notification
          client-payload: |
            {
              "title": "${{ env.NOTIFICATION_TITLE }}",
              "content": "JMæ¼«ç”»ä¸‹è½½ä»»åŠ¡å·²å®Œæˆï¼\n\nğŸ“‹ ä»»åŠ¡è¯¦æƒ…ï¼š\n- æœ¬å­ID: ${{ env.JM_ALBUM_IDS || 'æœªæŒ‡å®š' }}\n- ç« èŠ‚ID: ${{ env.JM_PHOTO_IDS || 'æœªæŒ‡å®š' }}\n- å‹ç¼©åŒ…: ${{ env.ZIP_NAME }}\n- PDFæ–‡ä»¶: ${{ env.ENABLE_PDF == 'true' && env.PDF_ZIP_NAME || 'æœªç”Ÿæˆ' }}\n- æ‰§è¡Œæ—¶é—´: ${{ github.run_id }}\n\nğŸ”— æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "source": "jmcomic-crawler",
              "timestamp": "${{ github.event.head_commit.timestamp }}",
              "attachments": ${{ steps.prepare_attachments.outputs.attachments }},
              "metadata": {
                "workflow": "download_with_notification",
                "run_id": "${{ github.run_id }}",
                "repository": "${{ github.repository }}",
                "actor": "${{ github.actor }}"
              }
            }

      # é€šçŸ¥å‘é€çŠ¶æ€è®°å½•
      - name: è®°å½•é€šçŸ¥çŠ¶æ€
        if: ${{ env.ENABLE_NOTIFICATION == 'true' }}
        run: |
          echo "=== é€šçŸ¥å‘é€å®Œæˆ ==="
          echo "ç›®æ ‡ä»“åº“: ${{ env.NOTIFICATION_REPO }}"
          echo "é€šçŸ¥æ ‡é¢˜: ${{ env.NOTIFICATION_TITLE }}"
          echo "é™„ä»¶æ•°é‡: $(echo '${{ steps.prepare_attachments.outputs.attachments }}' | jq length)"
          echo "å‘é€æ—¶é—´: $(date)"